<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jee="http://www.springframework.org/schema/jee"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="
		http://www.springframework.org/schema/jee
		http://www.springframework.org/schema/jee/spring-jee-3.0.xsd
		http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-3.0.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx-3.0.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop-3.0.xsd">

	
    <bean id="blPersistenceUnitManager"
          class="org.broadleafcommerce.common.extensibility.jpa.MergePersistenceUnitManager">
        <property name="persistenceXmlLocations">
            <list>
                <value>classpath*:/META-INF/persistence-demo.xml</value>
            </list>
        </property>
        <property name="dataSources">
            <map>
                <entry key="jdbc/web" value-ref="webDS"/>
                <entry key="jdbc/webSecure" value-ref="webDS"/>
                <entry key="jdbc/cmsStorage" value-ref="webStorageDS"/>
                <!--<entry key="jdbc/webSandbox" value-ref="webSandboxDS"/>-->
            </map>
        </property>
        <property name="defaultDataSource" ref="webDS"/>
    </bean>
    
    <bean id="webDS" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
		<property name="driverClassName" value="org.hsqldb.jdbcDriver" />
		<property name="url" value="jdbc:hsqldb:hsql://localhost/broadleaf;ifexists=true" />
		<property name="username" value="sa" />
		<property name="password" value="" />
	</bean>

    <bean id="webStorageDS" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
		<property name="driverClassName" value="org.hsqldb.jdbcDriver" />
		<property name="url" value="jdbc:hsqldb:hsql://localhost/broadleaf;ifexists=true" />
		<property name="username" value="sa" />
		<property name="password" value="" />
	</bean>
	
	<!--<bean id="webSandboxDS" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
		<property name="driverClassName" value="org.hsqldb.jdbcDriver" />
		<property name="url" value="jdbc:hsqldb:hsql://localhost/broadleaf_sndbx;ifexists=true" />
		<property name="username" value="sa" />
		<property name="password" value="" />
	</bean>-->
	
	<bean id="blCacheManager"
          class="org.broadleafcommerce.common.extensibility.cache.ehcache.MergeEhCacheManagerFactoryBean">
        <property name="shared" value="true"/>
        <property name="configLocations">
            <list>
                <value>classpath:bl-override-ehcache.xml</value>
            </list>
        </property>
    </bean>

    <bean id="blCatalogMultiplier" class="org.broadleafcommerce.core.util.demo.CatalogMultiplierImpl"/>

    <aop:config>
		<aop:pointcut id="blCatalogMultiplierOperation" expression="execution(* org.broadleafcommerce.core.util.demo.CatalogMultiplier.*(..))"/>
	    <aop:advisor advice-ref="blTxAdvice" pointcut-ref="blCatalogMultiplierOperation"/>
	</aop:config>

    <bean id="blProductDao" class="org.broadleafcommerce.core.catalog.dao.ProductDaoImpl">
        <property name="currentDateResolution" value="1000"/>
	</bean>

    <!--Braintree Configuration-->

    <bean id="blConfiguration" class="org.broadleafcommerce.common.config.RuntimeEnvironmentPropertiesConfigurer">
        <property name="propertyLocations">
            <set>
                <value>classpath:config/bc/</value>
                <value>classpath:config/bc/braintree/</value>
                <value>classpath:config/bc/override/</value>
            </set>
        </property>
        <property name="environments">
            <set>
                <value>development</value>
            </set>
        </property>
        <property name="defaultEnvironment" value="development"/>
        <property name="ignoreUnresolvablePlaceholders" value="true"/>
    </bean>

    <bean id="blBraintreeModule" class="org.broadleafcommerce.vendor.braintree.module.BraintreePaymentModule">
        <property name="gatewayRequest" ref="braintreeGateway"/>
    </bean>

    <bean id="braintreeGateway" class="org.broadleafcommerce.vendor.braintree.service.payment.BraintreeGatewayRequestImpl">
        <property name="publicKey" value="${braintree.publicKey}"/>
        <property name="privateKey" value="${braintree.privateKey}"/>
        <property name="merchantId" value="${braintree.merchantId}"/>
    </bean>

    <bean id="blBraintreePaymentService" class="org.broadleafcommerce.core.payment.service.PaymentServiceImpl">
        <property name="paymentModule" ref="blBraintreeModule"/>
    </bean>

    <bean id="blAuthorizeAndDebitWorkflow" class="org.broadleafcommerce.core.workflow.SequenceProcessor">
        <property name="processContextFactory">
            <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentProcessContextFactory">
                <property name="paymentActionType" value="AUTHORIZEANDDEBIT"/>
            </bean>
        </property>
        <property name="activities">
            <list>
                <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentActivity">
                    <property name="paymentService" ref="blBraintreePaymentService"/>
                    <property name="userName" value="web"/>
                </bean>
                <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentActivity">
                    <property name="paymentService" ref="blCreditCardService"/>
                    <property name="userName" value="web"/>
                </bean>
            </list>
        </property>
        <property name="defaultErrorHandler" ref="blDefaultErrorHandler"/>
    </bean>

    <bean id="authorizeAndDebitCompositePaymentService" class="org.broadleafcommerce.core.payment.service.CompositePaymentServiceImpl">
        <property name="paymentWorkflow" ref="blAuthorizeAndDebitWorkflow"/>
    </bean>

    <!-- A workflow for authorizing a payment with a payment service to engage it-->
    <bean id="blAuthorizeWorkflow" class="org.broadleafcommerce.core.workflow.SequenceProcessor">
        <property name="processContextFactory">
            <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentProcessContextFactory">
                <property name="paymentActionType" value="AUTHORIZE"/>
            </bean>
        </property>
        <property name="activities">
            <list>
                <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentActivity">
                    <property name="paymentService" ref="blBraintreePaymentService"/>
                    <property name="userName" value="web"/>
                </bean>
                <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentActivity">
                    <property name="paymentService" ref="blCreditCardService"/>
                    <property name="userName" value="web"/>
                </bean>
            </list>
        </property>
        <property name="defaultErrorHandler" ref="blDefaultErrorHandler"/>
    </bean>

    <bean id="authorizeCompositePaymentService" class="org.broadleafcommerce.core.payment.service.CompositePaymentServiceImpl">
        <property name="paymentWorkflow" ref="blAuthorizeWorkflow"/>
    </bean>


    <!-- A workflow for reversing an authorize with a payment service to engage it-->
    <bean id="blReverseAuthorizeWorkflow" class="org.broadleafcommerce.core.workflow.SequenceProcessor">
        <property name="processContextFactory">
            <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentProcessContextFactory">
                <property name="paymentActionType" value="REVERSEAUTHORIZE"/>
            </bean>
        </property>
        <property name="activities">
            <list>
                <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentActivity">
                    <property name="paymentService" ref="blBraintreePaymentService"/>
                    <property name="userName" value="web"/>
                </bean>
                <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentActivity">
                    <property name="paymentService" ref="blCreditCardService"/>
                    <property name="userName" value="web"/>
                </bean>
            </list>
        </property>
        <property name="defaultErrorHandler" ref="blDefaultErrorHandler"/>
    </bean>

    <bean id="reverseAuthorizeCompositePaymentService" class="org.broadleafcommerce.core.payment.service.CompositePaymentServiceImpl">
        <property name="paymentWorkflow" ref="blReverseAuthorizeWorkflow"/>
    </bean>

    <!-- A workflow for capturing an authorize with a payment service to engage it-->
    <bean id="blCaptureWorkflow" class="org.broadleafcommerce.core.workflow.SequenceProcessor">
        <property name="processContextFactory">
            <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentProcessContextFactory">
                <property name="paymentActionType" value="DEBIT"/>
            </bean>
        </property>
        <property name="activities">
            <list>
                <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentActivity">
                    <property name="paymentService" ref="blBraintreePaymentService"/>
                    <property name="userName" value="web"/>
                </bean>
                <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentActivity">
                    <property name="paymentService" ref="blCreditCardService"/>
                    <property name="userName" value="web"/>
                </bean>
            </list>
        </property>
        <property name="defaultErrorHandler" ref="blDefaultErrorHandler"/>
    </bean>

    <bean id="debitCompositePaymentService" class="org.broadleafcommerce.core.payment.service.CompositePaymentServiceImpl">
        <property name="paymentWorkflow" ref="blCaptureWorkflow"/>
    </bean>

    <!-- A workflow for refunding all or part of a previously completed sale with a payment service to engage it-->
    <bean id="blRefundWorkflow" class="org.broadleafcommerce.core.workflow.SequenceProcessor">
        <property name="processContextFactory">
            <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentProcessContextFactory">
                <property name="paymentActionType" value="CREDIT"/>
            </bean>
        </property>
        <property name="activities">
            <list>
                <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentActivity">
                    <property name="paymentService" ref="blBraintreePaymentService"/>
                    <property name="userName" value="web"/>
                </bean>
                <bean class="org.broadleafcommerce.core.payment.service.workflow.PaymentActivity">
                    <property name="paymentService" ref="blCreditCardService"/>
                    <property name="userName" value="web"/>
                </bean>
            </list>
        </property>
        <property name="defaultErrorHandler" ref="blDefaultErrorHandler"/>
    </bean>

    <bean id="refundCompositePaymentService" class="org.broadleafcommerce.core.payment.service.CompositePaymentServiceImpl">
        <property name="paymentWorkflow" ref="blRefundWorkflow"/>
    </bean>
</beans>